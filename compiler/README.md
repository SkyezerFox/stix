# Compiler

The Flux compiler is responsible for translating Flux source code into compiled Flux code (obviously). However, it's clearly not as simple as that, so I have gone into detail on how it works below.

## Usage

> Note: This is the usage specification for the compiler CLI, which does not currently exist! The Flux CLI is also referenced, which also does not currently exist!

### Run a Flux script

```sh
$ fluxc hello-world.stx
# or, use the flux CLI
$ flux build hello-world.stx
hello world!
```

### Compile a Flux script

```sh
$ fluxc --binary hello-world.stx -o hello-world
# or, use the flux CLI
$ flux compile hello-world.stx -o hello-world
$ ./hello-world
hello world!
```

## Stages

1. Lexing - The compiler takes an input source file and generates a stream of identifiable tokens.
2. Parsing - The compiler takes tokens generated by the previous step and produces an AST.
3. Semantic analysis - The compiler descends through the AST ensuring variables are correctly typed, referenced, and declared.
4. IR generation - The compiler produces LLVM IR from the AST.
5. Code generation - The compiler produces platform and architecture specific machine code.

## Crates

- [`fluxc_ast_passes`](./fluxc_ast_passes) - Defines the AST parses for the pre-IR generation phase.
- [`fluxc_ast`](./fluxc_ast) - Contains type definitions and handles the semantic analysis of the AST.
- [`fluxc_errors`](./fluxc_errors) - Error handling and message reporting crate.
- [`fluxc_ir`](./fluxc_ir) - Handles the generation of LLVM IR using the Cranelift IR generator from the AST.
- [`fluxc_main`](./fluxc_main) - The compiler entrypoint and step execution logic.
- [`fluxc_parser`](./fluxc_parser) - Parses a `TokenStream` into an AST.
- [`fluxc_span`](./fluxc_span) - Defines the `Span` type used in the compiler.
- [`fluxc_tests`](./fluxc_tests) - Contains tests for the compiler.
- [`fluxc_types`](./fluxc_types) - Defines the types used in the compiler.
- [`fluxc_walker`](./fluxc_walker) - Defines an AST walker for performing semantic analysis.
- [`fluxc`](./fluxc) - The compiler CLI interface.

## Modes

The Flux compiler has two distinct modes.

-   JIT - The compiler immediately triggers execution of compiles source code as soon as it is finished. Dynamic imports are enabled, and will be compiled as soon as they are imported.
-   AOT - The compiler builds a static binary for the target system and architecture which can be run at a later date.
